<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator | Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .invoice-container {
            background: #fff;
            color: #333;
            padding: 40px;
            border-radius: 8px;
            max-width: 800px;
            margin: 0 auto;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .company-details h2 {
            color: #1f2833;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .invoice-table th {
            background: #f4f4f4;
            color: #333;
        }

        .total-section {
            text-align: right;
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .invoice-container,
            .invoice-container * {
                visibility: visible;
            }

            .invoice-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
    <script>
        // Check Authentication (Robust Role Check)
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || (user.role !== 'admin' && user.role !== 'staff')) {
            window.location.href = '../login.html';
        }
    </script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar no-print">
            <div class="sidebar-header">
                <a href="#" class="sidebar-brand"><i class="fa-solid fa-shield-halved"></i> Manoj Security</a>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fa-solid fa-grip"></i> Dashboard</a></li>
                <li><a href="products.html"><i class="fa-solid fa-box"></i> Products</a></li>
                <li><a href="services.html"><i class="fa-solid fa-screwdriver-wrench"></i> Services</a></li>
                <li><a href="invoice.html" class="active"><i class="fa-solid fa-file-invoice-dollar"></i> Invoice</a>
                </li>
                <li><a href="#" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="top-bar no-print">
                <div class="menu-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
                <h1>Invoice Generator</h1>
            </div>

            <!-- Builder Section -->
            <div class="admin-section no-print">
                <h3>Build Invoice</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>Generic Customer Name</label>
                        <input type="text" id="custName" class="form-control" placeholder="Client Name">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="invDate" class="form-control">
                    </div>
                </div>

                <div style="background: #222; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4>Add Item</h4>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div style="flex: 2;">
                            <label>Product/Service</label>
                            <select id="prodSelect" class="form-control" onchange="updatePrice()">
                                <option value="">Select Item</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label>Price</label>
                            <input type="number" id="itemPrice" class="form-control">
                        </div>
                        <div style="flex: 0.5;">
                            <label>Qty</label>
                            <input type="number" id="itemQty" class="form-control" value="1">
                        </div>
                        <button onclick="addItem()" class="btn btn-primary" style="height: 45px;">Add</button>
                    </div>
                </div>
            </div>

            <!-- Invoice Preview -->
            <div class="invoice-container">
                <div class="invoice-header">
                    <div class="company-details">
                        <h2>Manoj Security Solutions</h2>
                        <p>Tamil Nadu, India</p>
                        <p>+91 99443 05980</p>
                    </div>
                    <div style="text-align: right;">
                        <h1 style="color: #66fcf1; text-transform: uppercase;">Invoice</h1>
                        <p>Date: <span id="dispDate"></span></p>
                        <p>Bill To: <span id="dispName">Guest</span></p>
                    </div>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="invItems">
                    </tbody>
                </table>

                <div class="total-section">
                    Grand Total: ₹<span id="grandTotal">0.00</span>
                </div>
            </div>

            <div class="no-print" style="margin-top: 20px; text-align: center;">
                <button onclick="window.print()" class="btn btn-primary"><i class="fa-solid fa-print"></i> Print
                    Invoice</button>
            </div>
        </main>
    </div>

    <script>
        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('open'); }
        function logout() { localStorage.removeItem('adminLoggedIn'); window.location.href = 'index.html'; }

        // Logic
        let products = [];
        let invoiceItems = [];

        // Init
        document.getElementById('invDate').valueAsDate = new Date();
        document.getElementById('dispDate').innerText = new Date().toLocaleDateString();

        // Check for client query param
        const urlParams = new URLSearchParams(window.location.search);
        const clientName = urlParams.get('client');
        if (clientName) {
            document.getElementById('custName').value = clientName;
            document.getElementById('dispName').innerText = clientName;
        }

        document.getElementById('custName').addEventListener('input', (e) => {
            document.getElementById('dispName').innerText = e.target.value || 'Guest';
        });

        document.getElementById('invDate').addEventListener('change', (e) => {
            document.getElementById('dispDate').innerText = new Date(e.target.value).toLocaleDateString();
        });

        fetch('/api/products')
            .then(res => res.json())
            .then(data => {
                products = data;
                const sel = document.getElementById('prodSelect');
                data.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = p.name;
                    opt.dataset.price = p.price || 0;
                    sel.appendChild(opt);
                });
            });

        function updatePrice() {
            const sel = document.getElementById('prodSelect');
            const price = sel.options[sel.selectedIndex].dataset.price;
            document.getElementById('itemPrice').value = price;
        }

        function addItem() {
            const sel = document.getElementById('prodSelect');
            const name = sel.options[sel.selectedIndex].text;
            const price = parseFloat(document.getElementById('itemPrice').value) || 0;
            const qty = parseInt(document.getElementById('itemQty').value) || 1;

            if (!sel.value) return;

            invoiceItems.push({ name, price, qty, total: price * qty });
            renderInvoice();
        }

        function renderInvoice() {
            const tbody = document.getElementById('invItems');
            tbody.innerHTML = '';
            let total = 0;

            invoiceItems.forEach(item => {
                total += item.total;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.qty}</td>
                        <td>₹${item.price}</td>
                        <td>₹${item.total}</td>
                    </tr>
                `;
            });
            document.getElementById('grandTotal').innerText = total.toFixed(2);
        }
    </script>
</body>

</html>